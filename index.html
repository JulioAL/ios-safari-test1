<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Query Params - iOS Safari</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; 
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1d1d1f;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .test-result { 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { 
            background-color: #d4edda; 
            border-left-color: #28a745;
        }
        .error { 
            background-color: #f8d7da; 
            border-left-color: #dc3545;
        }
        .warning { 
            background-color: #fff3cd; 
            border-left-color: #ffc107;
        }
        .info-block {
            background-color: #e7f3ff;
            border-left-color: #0066cc;
        }
        .code { 
            background: #f4f4f4; 
            padding: 12px; 
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            font-size: 13px;
            word-wrap: break-word;
        }
        h2 { 
            color: #333; 
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        h3 {
            color: #555;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .info { 
            color: #666; 
            font-size: 14px; 
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th {
            background: #f0f0f0;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-info { background: #17a2b8; color: white; }
        
        ul, ol {
            line-height: 1.8;
        }
        
        .status-icon {
            font-size: 24px;
            margin-right: 8px;
        }
        
        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #0056b3;
        }
        
        .url-example {
            background: #fff;
            border: 2px dashed #007bff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Query Parameters</h1>
        <p style="color: #666; font-size: 16px;">iOS Safari - Prueba de ATFP y Link Tracking Protection</p>
        
        <div class="info">
            <strong>üìã Instrucciones:</strong><br>
            Esta p√°gina debe abrirse con query parameters en la URL para realizar las pruebas.<br><br>
            <strong>Ejemplo de URL de prueba:</strong>
            <div class="url-example">
                <code id="example-url">https://tudominio.com/diagnostico-ios-safari.html?utm_source=email&utm_medium=newsletter&utm_campaign=test_ios&gclid=ABC123XYZ&fbclid=FB789DEF&session_id=sess_12345&custom_param=mi_valor</code>
            </div>
            <button class="copy-btn" onclick="copyExampleURL()">üìã Copiar URL de Ejemplo</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Funci√≥n para copiar URL de ejemplo
        function copyExampleURL() {
            const url = document.getElementById('example-url').textContent;
            const currentDomain = window.location.origin + window.location.pathname;
            const exampleURL = currentDomain + '?utm_source=email&utm_medium=newsletter&utm_campaign=test_ios&gclid=ABC123XYZ&fbclid=FB789DEF&session_id=sess_12345&custom_param=mi_valor';
            
            navigator.clipboard.writeText(exampleURL).then(() => {
                alert('‚úÖ URL copiada al portapapeles!\n\nPega esta URL en Safari para hacer la prueba.');
            }).catch(() => {
                alert('URL de ejemplo:\n\n' + exampleURL);
            });
        }

        // Funci√≥n para obtener todos los query parameters
        function getAllQueryParams() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);
            
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            
            return params;
        }

        // Funci√≥n para obtener info del navegador
        function getBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                vendor: navigator.vendor,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                screenResolution: screen.width + 'x' + screen.height,
                viewportSize: window.innerWidth + 'x' + window.innerHeight
            };
        }

        // Funci√≥n para verificar protecciones de Safari
        function checkSafariProtections() {
            const ua = navigator.userAgent;
            const isIOS = /iPhone|iPad|iPod/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/.test(ua);
            const isPrivateMode = false; // No se puede detectar confiablemente
            
            // Detectar versi√≥n de iOS
            let iOSVersion = null;
            if (isIOS) {
                const match = ua.match(/OS (\d+)_(\d+)_?(\d+)?/);
                if (match) {
                    iOSVersion = `${match[1]}.${match[2]}${match[3] ? '.' + match[3] : ''}`;
                }
            }
            
            return {
                isIOS: isIOS,
                isSafari: isSafari,
                iOSVersion: iOSVersion,
                likelyProtected: isIOS && isSafari
            };
        }

        // Funci√≥n para categorizar par√°metros
        function categorizeParam(key) {
            if (key.startsWith('utm_')) return { type: 'UTM (Marketing)', color: 'info' };
            if (['gclid', 'gbraid', 'wbraid'].includes(key.toLowerCase())) return { type: 'Google Click ID', color: 'warning' };
            if (['fbclid', 'fb_action_ids'].includes(key.toLowerCase())) return { type: 'Facebook Click ID', color: 'warning' };
            if (['msclkid'].includes(key.toLowerCase())) return { type: 'Microsoft Click ID', color: 'warning' };
            if (key.includes('session') || key.includes('token') || key.includes('auth')) return { type: 'Sesi√≥n/Auth', color: 'danger' };
            return { type: 'Personalizado', color: 'success' };
        }

        // Funci√≥n para mostrar resultados
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const params = getAllQueryParams();
            const browserInfo = getBrowserInfo();
            const safariCheck = checkSafariProtections();
            
            let html = '';

            // Test 1: Detecci√≥n de Safari/iOS
            const browserClass = safariCheck.likelyProtected ? 'warning' : 'success';
            html += `<div class="test-result ${browserClass}">`;
            html += '<h2><span class="status-icon">üì±</span>Test 1: Detecci√≥n de Navegador y Plataforma</h2>';
            html += `<p><strong>iOS detectado:</strong> ${safariCheck.isIOS ? '<span class="badge badge-warning">S√ç ‚ö†Ô∏è</span>' : '<span class="badge badge-success">NO ‚úì</span>'}</p>`;
            if (safariCheck.iOSVersion) {
                html += `<p><strong>Versi√≥n iOS:</strong> <span class="badge badge-info">${safariCheck.iOSVersion}</span></p>`;
            }
            html += `<p><strong>Safari detectado:</strong> ${safariCheck.isSafari ? '<span class="badge badge-warning">S√ç ‚ö†Ô∏è</span>' : '<span class="badge badge-success">NO ‚úì</span>'}</p>`;
            html += `<p><strong>Plataforma:</strong> ${browserInfo.platform}</p>`;
            html += '<p><strong>User Agent:</strong></p>';
            html += `<div class="code">${browserInfo.userAgent}</div>`;
            
            if (safariCheck.likelyProtected) {
                html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">';
                html += '‚ö†Ô∏è <strong>Atenci√≥n:</strong> Est√°s usando Safari en iOS. Las protecciones de privacidad pueden estar activas.';
                html += '</div>';
            }
            html += '</div>';

            // Test 2: URL Completa
            html += '<div class="test-result info-block">';
            html += '<h2><span class="status-icon">üîó</span>Test 2: URL Completa y Query String</h2>';
            html += '<p><strong>URL completa:</strong></p>';
            html += `<div class="code">${window.location.href}</div>`;
            html += '<p><strong>Query String (despu√©s del ?):</strong></p>';
            html += `<div class="code">${window.location.search || '<span style="color: #dc3545;">(VAC√çO - No hay query string)</span>'}</div>`;
            html += '<p><strong>Hash (despu√©s del #):</strong></p>';
            html += `<div class="code">${window.location.hash || '(vac√≠o)'}</div>`;
            html += '</div>';

            // Test 3: Query Parameters Detectados
            const paramCount = Object.keys(params).length;
            const paramsClass = paramCount > 0 ? 'success' : 'error';
            html += `<div class="test-result ${paramsClass}">`;
            html += '<h2><span class="status-icon">üéØ</span>Test 3: Query Parameters Detectados por JavaScript</h2>';
            html += `<p><strong>Total de par√°metros encontrados:</strong> <span class="badge ${paramCount > 0 ? 'badge-success' : 'badge-danger'}">${paramCount}</span></p>`;
            
            if (paramCount > 0) {
                // Agrupar por categor√≠a
                const utmParams = [];
                const clickIdParams = [];
                const sessionParams = [];
                const otherParams = [];
                
                for (const [key, value] of Object.entries(params)) {
                    const cat = categorizeParam(key);
                    const paramData = { key, value, ...cat };
                    
                    if (cat.type.includes('UTM')) utmParams.push(paramData);
                    else if (cat.type.includes('Click ID')) clickIdParams.push(paramData);
                    else if (cat.type.includes('Sesi√≥n')) sessionParams.push(paramData);
                    else otherParams.push(paramData);
                }
                
                html += '<table>';
                html += '<tr><th>Par√°metro</th><th>Valor</th><th>Categor√≠a</th></tr>';
                
                const allParams = [...utmParams, ...clickIdParams, ...sessionParams, ...otherParams];
                allParams.forEach(param => {
                    html += '<tr>';
                    html += `<td><code><strong>${param.key}</strong></code></td>`;
                    html += `<td><code>${param.value}</code></td>`;
                    html += `<td><span class="badge badge-${param.color}">${param.type}</span></td>`;
                    html += '</tr>';
                });
                html += '</table>';
                
                // Resumen por categor√≠a
                html += '<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">';
                html += '<strong>üìä Resumen:</strong><br>';
                html += `‚úÖ UTM parameters: ${utmParams.length}<br>`;
                html += `${clickIdParams.length > 0 ? '‚úÖ' : '‚ö†Ô∏è'} Click IDs (gclid, fbclid, etc): ${clickIdParams.length}<br>`;
                html += `‚úÖ Par√°metros de sesi√≥n: ${sessionParams.length}<br>`;
                html += `‚úÖ Otros par√°metros: ${otherParams.length}`;
                html += '</div>';
                
            } else {
                html += '<div style="padding: 20px; background: #f8d7da; border-radius: 5px; border-left: 4px solid #dc3545;">';
                html += '<p style="color: #721c24; margin: 0;"><strong>‚ùå NO se detectaron query parameters en la URL</strong></p>';
                html += '<p style="margin-top: 10px;">Esto puede deberse a:</p>';
                html += '<ul style="margin: 10px 0; padding-left: 20px;">';
                html += '<li><strong>Advanced Tracking and Fingerprinting Protection (ATFP)</strong> est√° activo en "All Browsing"</li>';
                html += '<li><strong>Link Tracking Protection (LTP)</strong> elimin√≥ los par√°metros</li>';
                html += '<li>La p√°gina se abri√≥ desde <strong>Mail</strong> o <strong>Messages</strong> (que eliminan click IDs)</li>';
                html += '<li>La URL no conten√≠a par√°metros al momento de cargar</li>';
                html += '</ul>';
                html += '</div>';
            }
            html += '</div>';

            // Test 4: document.referrer
            const hasReferrer = document.referrer !== '';
            html += `<div class="test-result ${hasReferrer ? 'success' : 'warning'}">`;
            html += '<h2><span class="status-icon">‚Ü©Ô∏è</span>Test 4: Document Referrer</h2>';
            html += '<p><strong>Referrer (de d√≥nde vienes):</strong></p>';
            
            if (hasReferrer) {
                html += `<div class="code">${document.referrer}</div>`;
                
                // Intentar extraer par√°metros del referrer
                try {
                    const refUrl = new URL(document.referrer);
                    const refParams = new URLSearchParams(refUrl.search);
                    const refParamCount = Array.from(refParams).length;
                    
                    if (refParamCount > 0) {
                        html += `<p style="margin-top: 10px;"><strong>Par√°metros en el Referrer:</strong> ${refParamCount}</p>`;
                        html += '<div class="code">';
                        for (const [key, value] of refParams) {
                            html += `${key}=${value}<br>`;
                        }
                        html += '</div>';
                    } else {
                        html += '<p style="margin-top: 10px; color: #666;">El referrer no contiene query parameters (pueden haber sido eliminados por Safari).</p>';
                    }
                } catch (e) {
                    html += '<p style="margin-top: 10px; color: #666;">No se pudieron analizar par√°metros del referrer.</p>';
                }
            } else {
                html += '<div class="code">(Vac√≠o - navegaci√≥n directa o referrer bloqueado)</div>';
                html += '<p style="margin-top: 10px; color: #666;">Esto es normal si:</p>';
                html += '<ul><li>Escribiste la URL directamente</li>';
                html += '<li>Usaste un marcador/favorito</li>';
                html += '<li>Safari bloque√≥ el referrer por privacidad</li></ul>';
            }
            html += '</div>';

            // Test 5: Capacidad de Cookies y Storage
            html += `<div class="test-result ${navigator.cookieEnabled ? 'success' : 'error'}">`;
            html += '<h2><span class="status-icon">üç™</span>Test 5: Cookies y Almacenamiento</h2>';
            html += `<p><strong>Cookies habilitadas:</strong> ${navigator.cookieEnabled ? '<span class="badge badge-success">S√ç ‚úì</span>' : '<span class="badge badge-danger">NO ‚úó</span>'}</p>`;
            
            // Test LocalStorage
            let localStorageAvailable = false;
            let localStorageError = '';
            try {
                localStorage.setItem('test_diagnostic', 'test');
                localStorage.removeItem('test_diagnostic');
                localStorageAvailable = true;
            } catch(e) {
                localStorageAvailable = false;
                localStorageError = e.message;
            }
            
            html += `<p><strong>LocalStorage disponible:</strong> ${localStorageAvailable ? '<span class="badge badge-success">S√ç ‚úì</span>' : '<span class="badge badge-danger">NO ‚úó</span>'}</p>`;
            if (!localStorageAvailable && localStorageError) {
                html += `<p style="color: #dc3545; font-size: 13px;">Error: ${localStorageError}</p>`;
            }
            
            // Test SessionStorage
            let sessionStorageAvailable = false;
            try {
                sessionStorage.setItem('test_diagnostic', 'test');
                sessionStorage.removeItem('test_diagnostic');
                sessionStorageAvailable = true;
            } catch(e) {
                sessionStorageAvailable = false;
            }
            
            html += `<p><strong>SessionStorage disponible:</strong> ${sessionStorageAvailable ? '<span class="badge badge-success">S√ç ‚úì</span>' : '<span class="badge badge-danger">NO ‚úó</span>'}</p>`;
            html += '</div>';

            // Test 6: Informaci√≥n adicional del sistema
            html += '<div class="test-result info-block">';
            html += '<h2><span class="status-icon">‚ÑπÔ∏è</span>Test 6: Informaci√≥n Adicional</h2>';
            html += `<p><strong>Idioma:</strong> ${browserInfo.language}</p>`;
            html += `<p><strong>Resoluci√≥n de pantalla:</strong> ${browserInfo.screenResolution}</p>`;
            html += `<p><strong>Tama√±o del viewport:</strong> ${browserInfo.viewportSize}</p>`;
            html += `<p><strong>Do Not Track:</strong> ${browserInfo.doNotTrack || 'no especificado'}</p>`;
            html += `<p><strong>Timestamp:</strong> ${new Date().toLocaleString('es-ES')}</p>`;
            html += '</div>';

            // Recomendaciones finales
            html += '<div class="test-result warning">';
            html += '<h2><span class="status-icon">üí°</span>Recomendaciones y Pr√≥ximos Pasos</h2>';
            
            if (safariCheck.likelyProtected && paramCount === 0) {
                html += '<div style="background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #dc3545;">';
                html += '<h3 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è Problema Detectado: Query Parameters Bloqueados</h3>';
                html += '<p><strong>Configuraci√≥n de Safari a verificar en tu iPhone/iPad:</strong></p>';
                html += '<ol>';
                html += '<li>Abre la app <strong>Ajustes</strong></li>';
                html += '<li>Ve a <code>Apps > Safari > Avanzado</code></li>';
                html += '<li>Toca <strong>"Protecci√≥n avanzada contra rastreo y fingerprinting"</strong></li>';
                html += '<li>Verifica el ajuste actual:</li>';
                html += '<ul style="margin-top: 10px;">';
                html += '<li><strong>"Navegaci√≥n privada"</strong> (predeterminado) - Solo bloquea en modo privado</li>';
                html += '<li><strong>"Toda la navegaci√≥n"</strong> - Bloquea en navegaci√≥n normal tambi√©n ‚ö†Ô∏è</li>';
                html += '<li><strong>"Desactivado"</strong> - No bloquea (no recomendado)</li>';
                html += '</ul>';
                html += '</ol>';
                html += '</div>';
            }
            
            html += '<h3>üîß Soluciones para tu sitio web:</h3>';
            html += '<ol>';
            html += '<li><strong>Server-Side Tracking:</strong> Captura los query parameters en el servidor antes de que Safari pueda eliminarlos. El servidor ve los par√°metros completos en la URL de la petici√≥n HTTP.</li>';
            html += '<li><strong>Cookies First-Party del Servidor:</strong> Cuando detectes par√°metros de campa√±a en el servidor, gu√°rdalos en cookies establecidas por el servidor (no JavaScript).</li>';
            html += '<li><strong>POST en lugar de GET:</strong> Para datos cr√≠ticos de sesi√≥n, usa m√©todos POST en lugar de query parameters.</li>';
            html += '<li><strong>Hash/Fragment (#):</strong> Los par√°metros despu√©s de # no se env√≠an al servidor pero JavaScript s√≠ puede leerlos (menos afectado por ATFP).</li>';
            html += '<li><strong>Usar gbraid/wbraid:</strong> Google ofrece estos par√°metros alternativos dise√±ados para Safari con privacidad mejorada.</li>';
            html += '</ol>';
            
            html += '<h3>üìã Pruebas adicionales recomendadas:</h3>';
            html += '<ul>';
            html += '<li>Abre esta misma URL desde la app <strong>Mail</strong> (env√≠ate un email con el link)</li>';
            html += '<li>Abre desde <strong>Messages</strong> (env√≠ate un SMS con el link)</li>';
            html += '<li>Prueba en <strong>modo privado de Safari</strong></li>';
            html += '<li>Prueba con ATFP cambiado a "Toda la navegaci√≥n"</li>';
            html += '<li>Compara con navegaci√≥n en <strong>Chrome iOS</strong> o <strong>Firefox iOS</strong></li>';
            html += '</ul>';
            
            html += '</div>';

            resultsDiv.innerHTML = html;
            
            // Log en consola para debugging
            console.group('üîç Diagn√≥stico iOS Safari - Resultados');
            console.log('Query Parameters:', params);
            console.log('Total Parameters:', paramCount);
            console.log('Browser Info:', browserInfo);
            console.log('Safari Check:', safariCheck);
            console.log('Document Referrer:', document.referrer);
            console.log('Full URL:', window.location.href);
            console.groupEnd();
        }

        // Ejecutar cuando cargue la p√°gina
        window.addEventListener('load', displayResults);
    </script>
</body>
</html>
